<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name="hugo-theme" content="Axiom 0.8.0">



  <link rel="icon" type="image/png" sizes="32x32" href="/">
  <link rel="icon" type="image/x-icon" href="/">
  <link rel="apple-touch-icon" href="/">
  <link rel="canonical" href="https://rtichoke.netlify.app/post/monotonic_binning_using_xgboost/">
<link rel="preload" as="style" href="/bundle.css?v=1632374292" media="all">
<link rel="stylesheet" href="/bundle.css?v=1632374292" media="all">
<style>.cdata pre{background-color:#1f2937;color:#e5e7eb}.cdata :not(pre)>code{background-color:#f3f4f6;color:#7c3aed}.chroma .err{background-color:#991b1b;color:#fecaca}.chroma .hl{background-color:#374151}.chroma .ln{color:#9ca3af}.chroma .k,.chroma .kc,.chroma .kd,.chroma .kn,.chroma .kp,.chroma .kr{color:#60a5fa}.chroma .kt{color:#a78bfa}.chroma .na,.chroma .nb{color:#fbbf24}.chroma .nc{color:#f87171}.chroma .no{color:#34d399}.chroma .nd{color:#f87171}.chroma .ne{color:#f87171}.chroma .nf{color:#fbbf24}.chroma .nt{color:#f87171}.chroma .l{color:#a78bfa}.chroma .dl,.chroma .ld,.chroma .s,.chroma .s2,.chroma .sa,.chroma .sb,.chroma .sc,.chroma .sd{color:#34d399}.chroma .se{color:#9ca3af}.chroma .s1,.chroma .sh,.chroma .si,.chroma .sr,.chroma .ss,.chroma .sx{color:#34d399}.chroma .il,.chroma .m,.chroma .mb,.chroma .mf,.chroma .mh,.chroma .mi,.chroma .mo{color:#a78bfa}.chroma .o,.chroma .ow{color:#93c5fd}.chroma .c,.chroma .c1,.chroma .ch,.chroma .cm,.chroma .cp,.chroma .cpf,.chroma .cs,.chroma .p{color:#9ca3af}.chroma .ge{font-style:italic}.chroma .gs{font-weight:700}
</style>



<title>Monotonic binning using XGBOOST : R&#39;tichoke</title>

<meta property="og:title" content="Monotonic binning using XGBOOST">
<meta property="og:site_name" content="R&#39;tichoke">
<meta property="og:url" content="https://rtichoke.netlify.app/post/monotonic_binning_using_xgboost/">
<link rel="image_src" href="https://rtichoke.netlify.app/">
<meta property="og:image" content="https://rtichoke.netlify.app/">
<meta property="og:image:width" content="">
<meta property="og:image:height" content="">
<meta property="og:type" content="article">
<meta property="og:locale" content="en_us">
<meta property="og:description" content="How to create a discrete data bins with monotonic event rates using xgboost">
<meta name="description" content="How to create a discrete data bins with monotonic event rates using xgboost">
<meta property="og:updated_time" content="2021-09-17T00:00:00Z">
<meta property="fb:app_id" content="">
<meta name="author" content="Riddhiman">
<meta property="article:author" content="https://linkedin.com/in/riddhimanr">
<meta property="article:published_time" content="2021-09-17T00:00:00Z">
<meta property="article:modified_time" content="2021-09-17T00:00:00Z">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "Monotonic binning using XGBOOST",
  "alternativeHeadline": "Credit risk series (Post #2)",
  "url": "https://rtichoke.netlify.app/post/monotonic_binning_using_xgboost/",
  "image": "https://rtichoke.netlify.app/",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://rtichoke.netlify.app/post/monotonic_binning_using_xgboost/"
  },
  "description": "How to create a discrete data bins with monotonic event rates using xgboost",
  "author": {
    "@type": "Person",
    "name": "Riddhiman"
  },
  "publisher": {
    "@type": "Organization",
    "name": "R'tichoke",
    "logo": {
      "@type": "ImageObject",
      "url": "https://rtichoke.netlify.app/"
    }
  },
  "datePublished": "2021-09-17T00:00:00Z",
  "dateModified": "2021-09-17T00:00:00Z",
  "articleBody": "\u003cp\u003eWhen developing credit risk scorecards, it is generally a good idea to discretise (bin) numeric variables in a manner that ensures monotonically increasing or decreasing event rates as the variable increases or decreases. While discretising individual variables adds stability to the model, monotonic bins ensure that the model output is consistent and interpretable (i.e. if variable \u0026lsquo;x\u0026rsquo; increases, the computed score increases across each bin). We\u0026rsquo;ll explore how to do create monotonic bins in \u003ccode\u003eR\u003c/code\u003e using \u003ccode\u003exgboost\u003c/code\u003e.\u003c/p\u003e\n\u003ch2 id=\"libraries\"\u003eLibraries\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Pacman is a package management tool \u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003einstall.packages\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;pacman\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(pacman)\n\n\u003cspan style=\"color:#75715e\"\u003e# p_load automatically installs packages if needed\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ep_load\u003c/span\u003e(recipes, dplyr, ggplot2, xgboost, gridExtra)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"sample-dataset\"\u003eSample dataset\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/royr2/blog/blob/main/download/credit_sample.csv\"\u003eHere\u0026rsquo;s\u003c/a\u003e a small sample sample of the \u003cstrong\u003eLending Club\u003c/strong\u003e dataset available on \u003ca href=\"https://www.kaggle.com/wordsforthewise/lending-club\"\u003eKaggle\u003c/a\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003esample \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eread.csv\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;credit_sample.csv\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003edim\u003c/span\u003e(sample)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 10000   153\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eclass\u003c/span\u003e(sample)\n\u003cspan style=\"color:#75715e\"\u003e## [1] \u0026#34;data.frame\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"create-a-target\"\u003eCreate a target\u003c/h2\u003e\n\u003cp\u003eLike in my previous \u003ca href=\"/post/gains_table\"\u003epost\u003c/a\u003e, I\u0026rsquo;ll use the \u003ccode\u003eloan_status\u003c/code\u003e column as the target variable.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Specific values to be tagged as \u0026#39;bad\u0026#39;\u003c/span\u003e\ncodes \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Charged Off\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Does not meet the credit policy. Status:Charged Off\u0026#34;\u003c/span\u003e)\n\nmodel_data \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e sample \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(bad_flag \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(loan_status \u003cspan style=\"color:#f92672\"\u003e%in%\u003c/span\u003e codes, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"data-prep\"\u003eData prep\u003c/h2\u003e\n\u003cp\u003eWe\u0026rsquo;ll use the \u003ccode\u003erecipes\u003c/code\u003e package to remove non numeric variables and impute missing values using. For additional details, see the \u003ca href=\"https://recipes.tidymodels.org/\"\u003edocumentation\u003c/a\u003e for \u003ccode\u003erecipes\u003c/code\u003e. Note that the formula inside the \u003ccode\u003erecipe()\u003c/code\u003e function decides which columns are predictors and which column is the target.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Specify basic recipe\u003c/span\u003e\nrec \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erecipe\u003c/span\u003e(bad_flag \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e ., data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_data) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estep_select\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ewhere\u003c/span\u003e(is.numeric)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003estep_impute_median\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eall_predictors\u003c/span\u003e())\n\nrec \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eprep\u003c/span\u003e(rec, training \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_data)\n\n\u003cspan style=\"color:#75715e\"\u003e# Not doing a test/train split \u003c/span\u003e\ntrain \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebake\u003c/span\u003e(rec, new_data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_data)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"analysing-directional-trend\"\u003eAnalysing directional trend\u003c/h2\u003e\n\u003cp\u003eNow that we have a clean training dataset, its important to ascertain how the event rate \u003cem\u003eshould\u003c/em\u003e change when a particular variable changes. This is important since this directional trend will dictate how we constraint the \u003ccode\u003exgboost\u003c/code\u003e model.\u003c/p\u003e\n\u003cp\u003eA good way to do this is to use both data and intuition. As an example, consider the variable \u003ccode\u003einq_last_6mths\u003c/code\u003e (number of inquiries in the last 6 months). Intuitively, as the number of inquiries increase, one would expect the event rate (chance of default) to increase. We can validate this using a simple bar chart like the one shown below.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_data\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003einq_last_6mths,\n           y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_data\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ebad_flag) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(x) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003esummarise\u003c/span\u003e(count \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e(), \n            events \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(y)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(pct \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e events\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003ecount) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(x), y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e pct)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;# of inquiries in past 6 months\u0026#34;\u003c/span\u003e, \n       y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Default rate\u0026#34;\u003c/span\u003e, \n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Default rate vs number of inquiries in past 6 months\u0026#34;\u003c/span\u003e, \n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Positive relationship\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"chart1-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eThis confirms our hypothesis and also tells us that we need to constraint the \u003ccode\u003exgboost\u003c/code\u003e model such the probability outcome increases as the value of the variable \u003ccode\u003einq_last_6mths\u003c/code\u003e increases.\u003c/p\u003e\n\u003ch2 id=\"xgboost-model\"\u003exgboost model\u003c/h2\u003e\n\u003cp\u003eWe\u0026rsquo;ll create an xgb model with the following specs:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eOne boosting iteration\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emonotone_constraints\u003c/code\u003e = 1 (i.e. splits which only increase the probability outcome)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emax_depth\u003c/code\u003e = 10 (as an example, can be deeper if one needs additional bins)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emdl \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003exgboost\u003c/span\u003e(\n  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e train \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(inq_last_6mths) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e## Select only inq_last_6mths\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003eas.matrix\u003c/span\u003e(),  \u003cspan style=\"color:#75715e\"\u003e## convert to matrix since the xgboost() interface only accepts matrices\u003c/span\u003e\n  label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e train[[\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bad_flag\u0026#34;\u003c/span\u003e]],  \u003cspan style=\"color:#75715e\"\u003e## Target variable\u003c/span\u003e\n  nrounds \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,  \u003cspan style=\"color:#75715e\"\u003e## Only one boosting iteration\u003c/span\u003e\n  params \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(objective \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;binary:logistic\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#75715e\"\u003e## Binary outcome\u003c/span\u003e\n                monotone_constraints \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \n                max_depth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e))  \u003cspan style=\"color:#75715e\"\u003e## 1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [10:48:08] WARNING: amalgamation/../src/learner.cc:1095: Starting in XGBoost 1.3.0, the default evaluation metric used with the objective \u0026#39;binary:logistic\u0026#39; was changed from \u0026#39;error\u0026#39; to \u0026#39;logloss\u0026#39;. Explicitly set eval_metric if you\u0026#39;d like to restore the old behavior.\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1]\ttrain-logloss:0.541928\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"retrieving-splits\"\u003eRetrieving splits\u003c/h2\u003e\n\u003cp\u003eNow that we have a model, we need to retrieve the split points and evaluate whether the binning scheme is intuitive (or not).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Convert model into a dataframe like output\u003c/span\u003e\nsplits \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003exgb.model.dt.tree\u003c/span\u003e(model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e mdl)  \n\n\u003cspan style=\"color:#75715e\"\u003e# Add +/- Inf to provide coverage for values not observed \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# in the training dataset\u003c/span\u003e\ncuts \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eInf\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esort\u003c/span\u003e(splits\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eSplit), \u003cspan style=\"color:#66d9ef\"\u003eInf\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Plot bins and event rates\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e(target \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e train\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ebad_flag,\n           buckets \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecut\u003c/span\u003e(train\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003einq_last_6mths, \n                         breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cuts, \n                         include.lowest \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e T, \n                         right \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e T, \n                         ordered_result \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e T)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(buckets) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarise\u003c/span\u003e(total \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e(),\n            events \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(target \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(pct \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e events\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003etotal) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e buckets, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e pct)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Bins\u0026#34;\u003c/span\u003e, \n       y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Default rate\u0026#34;\u003c/span\u003e, \n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Monotonic binning for number of inquiries in past 6 months\u0026#34;\u003c/span\u003e, \n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Monotonically increasing event rate\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"chart2-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"creating-a-function\"\u003eCreating a function\u003c/h2\u003e\n\u003cp\u003eFinally, we can encapsulate everything we have done so far inside a function for better usability.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ecreate_bins \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(var, outcome, max_depth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, plot \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e T){\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Check if relationship is positive or negative \u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Using spearman since it measures strength of monotonic relationship \u003c/span\u003e\n  corr \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecor\u003c/span\u003e(var, outcome, method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;spearman\u0026#34;\u003c/span\u003e)\n  direction \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(corr \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e-1\u003c/span\u003e)\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Build XGB model \u003c/span\u003e\n  mdl \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003exgboost\u003c/span\u003e(\n    verbose \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e,\n    data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.matrix\u003c/span\u003e(var),\n    label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e outcome,\n    nrounds \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,  \n    params \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(objective \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;binary:logistic\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#75715e\"\u003e## Binary outcome\u003c/span\u003e\n                  monotone_constraints \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e direction, \n                  max_depth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e max_depth, \n                  eval_metric \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;auc\u0026#34;\u003c/span\u003e))\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Retrieve splits \u003c/span\u003e\n  splits \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003exgb.model.dt.tree\u003c/span\u003e(model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e mdl)\n  cuts \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eInf\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esort\u003c/span\u003e(splits\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eSplit), \u003cspan style=\"color:#66d9ef\"\u003eInf\u003c/span\u003e)\n  binned \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecut\u003c/span\u003e(var, \n                breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cuts, \n                include.lowest \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e T, \n                right \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e T, \n                ordered_result \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e T)\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Create an event rate plot\u003c/span\u003e\n  plt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e(outcome, binned) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n      \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(binned) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n      \u003cspan style=\"color:#a6e22e\"\u003esummarise\u003c/span\u003e(total \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e(),\n                events \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(outcome \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n      \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(pct \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e events\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003etotal) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n      \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e binned, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e pct)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n      \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n      \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n      \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Bins\u0026#34;\u003c/span\u003e, \n           y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Event Rate\u0026#34;\u003c/span\u003e, \n           title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Monotonic binning output\u0026#34;\u003c/span\u003e)\n    \n  \u003cspan style=\"color:#a6e22e\"\u003eif\u003c/span\u003e(plot \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e T){\n    \u003cspan style=\"color:#a6e22e\"\u003eprint\u003c/span\u003e(plt)\n  }\n  \n  \u003cspan style=\"color:#75715e\"\u003e# List to be returned\u003c/span\u003e\n  lst \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(\n    var \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e var, \n    binned_var \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e binned, \n    cor \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e corr, \n    plot \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e plt\n  )\n  \n  \u003cspan style=\"color:#a6e22e\"\u003ereturn\u003c/span\u003e(lst)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Test function\u003c/span\u003e\nv1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecreate_bins\u003c/span\u003e(train\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003efico_range_high, train\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ebad_flag, max_depth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, plot \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e F)\nv2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecreate_bins\u003c/span\u003e(train\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003edelinq_amnt, train\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ebad_flag, max_depth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, plot \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e F)\nv3 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecreate_bins\u003c/span\u003e(train\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eint_rate, train\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ebad_flag, max_depth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, plot \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e F)\nv4 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecreate_bins\u003c/span\u003e(train\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eannual_inc, train\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ebad_flag, max_depth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, plot \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e F)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003egrid.arrange\u003c/span\u003e(v1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eplot \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Fico Range High\u0026#34;\u003c/span\u003e), \n             v2\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eplot \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Delinq Amount\u0026#34;\u003c/span\u003e), \n             v3\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eplot \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Interest Rate\u0026#34;\u003c/span\u003e), \n             v4\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eplot \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Annual Income\u0026#34;\u003c/span\u003e), \n             ncol \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"chart3-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eAnd that\u0026rsquo;s it! We can use what we just built to discretise variables we need, perform \u003ccode\u003eone-hot-encoding\u003c/code\u003e or \u003ccode\u003eWOE-transformations\u003c/code\u003e and feed the appropriate model matrix to our choice of statistical routine.\u003c/p\u003e\n\u003ch2 id=\"parting-notes\"\u003eParting notes\u003c/h2\u003e\n\u003cp\u003eCheck out this package called \u003ca href=\"https://github.com/statcompute/mob\"\u003e\u003ccode\u003eMonotonicOptimalBinning\u003c/code\u003e\u003c/a\u003e by Wensui Liu which offers multiple binning strategies like isotonic binning, quantile binning and k-means binning.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eThoughts? Comments? Helpful? Not helpful? Like to see anything else added in here? Let me know!\u003c/em\u003e\u003c/p\u003e"
}
</script>

<link rel="preload" as="script" href="/bundle.js?v=1632374292">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://stats.g.doubleclick.net">
<link rel="preconnect" href="https://www.googleadservices.com">
<link rel="preload" as="script" href="https://www.googletagmanager.com/gtag/js?id=UA-57026003-1">
<script src="https://www.googletagmanager.com/gtag/js?id=UA-57026003-1"></script>
<script>
  window.dataLayer=window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js',new Date());
  gtag('config','UA-57026003-1');
</script>

</head>
<body>

  <header id="nav" class="header">
  <div class="ax-l-i max-w-6xl">
    <div class="ax-logo">
      <a class="block" href="/" title="R&#39;tichoke"><span class="font-semibold text-raven-900">R'tichoke</span></a>
    </div>
    <div class="ax-user">
      <a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target="_blank" rel="noopener nofollow" href="https://www.google.com/search?q=site:https://rtichoke.netlify.app/" title="Search">
        <svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923l-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33 0 0 0 2.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg>

      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="/post/">
        Posts
      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="/about/">
        About
      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="/rbloggers/">
        R-Bloggers
      </a>
    </div>
  </div>

  
</header>

  <main>
<div class="default-single">
  <div class="ax-title ax-l-o">
    <div class="ax-l-i max-w-4xl">
      <h1 class="post-title font-content-title font-normal leading-tight tracking-default text-40">Monotonic binning using XGBOOST</h1>
      <p class="post-subtitle font-content-sans font-light text-xl text-raven-500 mt-3">Credit risk series (Post #2)</p>

      <div class="ax-meta flex items-center mt-5">
        <div class="flex-grow min-w-0">
          <div class="flex items-center">
  
  <div class="flex-shrink-0">
    <img
    class="w-12 h-12 sm:w-14 sm:h-14 object-cover p-3px rounded-full border border-blue-300"
    src="data:image/svg&#43;xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMzIgMzIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI&#43;PHBhdGggZmlsbD0iI2VjZWZmMSIgZD0iTTAgMGgzMnYzMkgweiIvPjxwYXRoIGZpbGw9IiM0NTVhNjQiIGQ9Ik0yOS4zMDUgMjQuNDA3Yy0uNzk1LS42My0xLjc2NS0xLjA4LTIuODE2LTEuM0wyMS40NzYgMjIuMWExLjEzIDEuMTMgMCAwIDEtLjkwNS0xLjEydi0xLjE1Yy4zMjItLjQ1My42MjYtMS4wNTQuOTQ0LTEuNjgyLjI0Ny0uNDg3LjYyLTEuMjIuODA1LTEuNCAxLjAxNS0xLjAyIDEuOTk1LTIuMTY1IDIuMy0zLjY0LjI4My0xLjM4NS4wMDUtMi4xMTItLjMyMi0yLjY5NyAwLTEuNDYtLjA0Ni0zLjI5LS4zOS00LjYyLS4wNC0xLjgtLjM2OC0yLjgxNC0xLjE5LTMuNy0uNTgtLjYzLTEuNDM1LS43NzUtMi4xMjMtLjg5LS4yNy0uMDQ2LS42NDItLjEtLjc4LS4xODNDMTguNTk0LjM0NyAxNy40LjAyNSAxNS45NTIgMGMtMyAuMTIzLTYuNzEgMi4wNC03Ljk1IDUuNDU0LS4zODQgMS4wNC0uMzQ1IDIuNzQ3LS4zMTMgNC4xMmwtLjAzLjgyNWMtLjI5NS41NzYtLjU4NSAxLjMwNy0uMyAyLjY5Ny4zMDIgMS40OCAxLjI4MiAyLjYyNiAyLjMxNSAzLjY2LjE3LjE3NC41NS45MTQuODAyIDEuNDAzbC45NSAxLjY3NXYxLjE1YzAgLjU0Ni0uMzgyIDEuMDE3LS45IDEuMTJMNS41IDIzLjExYy0xLjA0NS4yMjItMi4wMTQuNjctMi44MDcgMS4yOThhMS4xNSAxLjE1IDAgMCAwLS40MjcuODA1IDEuMTQgMS4xNCAwIDAgMCAuMjkzLjg1OUM1Ljk3NSAyOS44MzggMTAuODczIDMyIDE2IDMyczEwLjAyNy0yLjE2IDEzLjQ0LTUuOTNhMS4xNCAxLjE0IDAgMCAwLS4xMzUtMS42NjR6Ii8&#43;PC9zdmc&#43;Cg=="
    alt="">
	</div>
    
  <div class="flex-shrink-0 ml-2 leading-tight font-content-sans">
    <a class="block text-sm text-raven-800 hover:text-raven-900 hover:underline focus:underline" target="_blank" rel="noopener nofollow" title="Riddhiman" href="https://linkedin.com/in/riddhimanr">Riddhiman</a>
    <time class="text-sm text-raven-500" datetime="2021-09-17T00:00:00Z">Sep 17, 2021</time>
  </div>
</div>

        </div>
        <div>
          

<div class="flex items-center">
    <a class="flex-shrink-0 block text-raven-800 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Share on Twitter" href="https://twitter.com/intent/tweet?text=Monotonic%20binning%20using%20XGBOOST%20by%20%40%25%21s%28%3cnil%3e%29%20https%3a%2f%2frtichoke.netlify.app%2fpost%2fmonotonic_binning_using_xgboost%2f"><svg class="w-6 h-6 fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11 0 0 1-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56 0 0 0-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57 0 0 0 2.914 5.452 6.48 6.48 0 0 1-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42 0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18 0 0 1-8.134 2.798c-.538 0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072 0 18.672-10 18.672-18.668 0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg>
</a>
    <a class="ml-3 flex-shrink-0 block text-raven-800 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Share on Facebook" href="https://www.facebook.com/dialog/share?app_id=&display=page&href=https%3a%2f%2frtichoke.netlify.app%2fpost%2fmonotonic_binning_using_xgboost%2f"><svg class="w-6 h-6 fill-current" viewBox="-7 -3.5 39 39" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.234 0H1.765C.8.001 0 .79 0 1.766v28.47C.001 31.2.79 32 1.766 32h15.328V19.625h-4.156V14.78h4.156v-3.564c0-4.134 2.523-6.384 6.21-6.384 1.766 0 3.284.13 3.726.2v4.32h-2.543c-2.006 0-2.394.953-2.394 2.352v3.085h4.797l-.625 4.844h-4.172V32h8.14C31.21 32 32 31.2 32 30.234V1.765C32 .8 31.21 0 30.234 0z"/></svg>
</a>
  
</div>
        </div>
      </div>
    </div>
  </div><div class="ax-content ax-l-o">
    <div class="ax-l-i max-w-4xl">
      <article class="cdata">
<p>When developing credit risk scorecards, it is generally a good idea to discretise (bin) numeric variables in a manner that ensures monotonically increasing or decreasing event rates as the variable increases or decreases. While discretising individual variables adds stability to the model, monotonic bins ensure that the model output is consistent and interpretable (i.e. if variable &lsquo;x&rsquo; increases, the computed score increases across each bin). We&rsquo;ll explore how to do create monotonic bins in <code>R</code> using <code>xgboost</code>.</p>
<h2 id="libraries">Libraries</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Pacman is a package management tool </span>
<span style="color:#a6e22e">install.packages</span>(<span style="color:#e6db74">&#34;pacman&#34;</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(pacman)

<span style="color:#75715e"># p_load automatically installs packages if needed</span>
<span style="color:#a6e22e">p_load</span>(recipes, dplyr, ggplot2, xgboost, gridExtra)
</code></pre></div><h2 id="sample-dataset">Sample dataset</h2>
<p><a href="https://github.com/royr2/blog/blob/main/download/credit_sample.csv">Here&rsquo;s</a> a small sample sample of the <strong>Lending Club</strong> dataset available on <a href="https://www.kaggle.com/wordsforthewise/lending-club">Kaggle</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">sample <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read.csv</span>(<span style="color:#e6db74">&#34;credit_sample.csv&#34;</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">dim</span>(sample)
<span style="color:#75715e">## [1] 10000   153</span>
<span style="color:#a6e22e">class</span>(sample)
<span style="color:#75715e">## [1] &#34;data.frame&#34;</span>
</code></pre></div><h2 id="create-a-target">Create a target</h2>
<p>Like in my previous <a href="/post/gains_table">post</a>, I&rsquo;ll use the <code>loan_status</code> column as the target variable.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Specific values to be tagged as &#39;bad&#39;</span>
codes <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Charged Off&#34;</span>, <span style="color:#e6db74">&#34;Does not meet the credit policy. Status:Charged Off&#34;</span>)

model_data <span style="color:#f92672">&lt;-</span> sample <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(bad_flag <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(loan_status <span style="color:#f92672">%in%</span> codes, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>))
</code></pre></div><h2 id="data-prep">Data prep</h2>
<p>We&rsquo;ll use the <code>recipes</code> package to remove non numeric variables and impute missing values using. For additional details, see the <a href="https://recipes.tidymodels.org/">documentation</a> for <code>recipes</code>. Note that the formula inside the <code>recipe()</code> function decides which columns are predictors and which column is the target.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Specify basic recipe</span>
rec <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">recipe</span>(bad_flag <span style="color:#f92672">~</span> ., data <span style="color:#f92672">=</span> model_data) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">step_select</span>(<span style="color:#a6e22e">where</span>(is.numeric)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">step_impute_median</span>(<span style="color:#a6e22e">all_predictors</span>())

rec <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">prep</span>(rec, training <span style="color:#f92672">=</span> model_data)

<span style="color:#75715e"># Not doing a test/train split </span>
train <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">bake</span>(rec, new_data <span style="color:#f92672">=</span> model_data)
</code></pre></div><h2 id="analysing-directional-trend">Analysing directional trend</h2>
<p>Now that we have a clean training dataset, its important to ascertain how the event rate <em>should</em> change when a particular variable changes. This is important since this directional trend will dictate how we constraint the <code>xgboost</code> model.</p>
<p>A good way to do this is to use both data and intuition. As an example, consider the variable <code>inq_last_6mths</code> (number of inquiries in the last 6 months). Intuitively, as the number of inquiries increase, one would expect the event rate (chance of default) to increase. We can validate this using a simple bar chart like the one shown below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">data.frame</span>(x <span style="color:#f92672">=</span> model_data<span style="color:#f92672">$</span>inq_last_6mths,
           y <span style="color:#f92672">=</span> model_data<span style="color:#f92672">$</span>bad_flag) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">filter</span>(x <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(x) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">summarise</span>(count <span style="color:#f92672">=</span> <span style="color:#a6e22e">n</span>(), 
            events <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum</span>(y)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(pct <span style="color:#f92672">=</span> events<span style="color:#f92672">/</span>count) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">factor</span>(x), y <span style="color:#f92672">=</span> pct)) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">geom_col</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme_minimal</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">labs</span>(x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;# of inquiries in past 6 months&#34;</span>, 
       y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Default rate&#34;</span>, 
       title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Default rate vs number of inquiries in past 6 months&#34;</span>, 
       subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Positive relationship&#34;</span>)
</code></pre></div><p><img src="chart1-1.png" alt=""></p>
<p>This confirms our hypothesis and also tells us that we need to constraint the <code>xgboost</code> model such the probability outcome increases as the value of the variable <code>inq_last_6mths</code> increases.</p>
<h2 id="xgboost-model">xgboost model</h2>
<p>We&rsquo;ll create an xgb model with the following specs:</p>
<ul>
<li>One boosting iteration</li>
<li><code>monotone_constraints</code> = 1 (i.e. splits which only increase the probability outcome)</li>
<li><code>max_depth</code> = 10 (as an example, can be deeper if one needs additional bins)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">mdl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">xgboost</span>(
  data <span style="color:#f92672">=</span> train <span style="color:#f92672">%&gt;%</span>
    <span style="color:#a6e22e">select</span>(inq_last_6mths) <span style="color:#f92672">%&gt;%</span>  <span style="color:#75715e">## Select only inq_last_6mths</span>
    <span style="color:#a6e22e">as.matrix</span>(),  <span style="color:#75715e">## convert to matrix since the xgboost() interface only accepts matrices</span>
  label <span style="color:#f92672">=</span> train[[<span style="color:#e6db74">&#34;bad_flag&#34;</span>]],  <span style="color:#75715e">## Target variable</span>
  nrounds <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,  <span style="color:#75715e">## Only one boosting iteration</span>
  params <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(objective <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;binary:logistic&#34;</span>, <span style="color:#75715e">## Binary outcome</span>
                monotone_constraints <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, 
                max_depth <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>))  <span style="color:#75715e">## 1</span>
<span style="color:#75715e">## [10:48:08] WARNING: amalgamation/../src/learner.cc:1095: Starting in XGBoost 1.3.0, the default evaluation metric used with the objective &#39;binary:logistic&#39; was changed from &#39;error&#39; to &#39;logloss&#39;. Explicitly set eval_metric if you&#39;d like to restore the old behavior.</span>
<span style="color:#75715e">## [1]	train-logloss:0.541928</span>
</code></pre></div><h2 id="retrieving-splits">Retrieving splits</h2>
<p>Now that we have a model, we need to retrieve the split points and evaluate whether the binning scheme is intuitive (or not).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Convert model into a dataframe like output</span>
splits <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">xgb.model.dt.tree</span>(model <span style="color:#f92672">=</span> mdl)  

<span style="color:#75715e"># Add +/- Inf to provide coverage for values not observed </span>
<span style="color:#75715e"># in the training dataset</span>
cuts <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#f92672">-</span><span style="color:#66d9ef">Inf</span>, <span style="color:#a6e22e">sort</span>(splits<span style="color:#f92672">$</span>Split), <span style="color:#66d9ef">Inf</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Plot bins and event rates</span>
<span style="color:#a6e22e">data.frame</span>(target <span style="color:#f92672">=</span> train<span style="color:#f92672">$</span>bad_flag,
           buckets <span style="color:#f92672">=</span> <span style="color:#a6e22e">cut</span>(train<span style="color:#f92672">$</span>inq_last_6mths, 
                         breaks <span style="color:#f92672">=</span> cuts, 
                         include.lowest <span style="color:#f92672">=</span> T, 
                         right <span style="color:#f92672">=</span> T, 
                         ordered_result <span style="color:#f92672">=</span> T)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(buckets) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">summarise</span>(total <span style="color:#f92672">=</span> <span style="color:#a6e22e">n</span>(),
            events <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum</span>(target <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(pct <span style="color:#f92672">=</span> events<span style="color:#f92672">/</span>total) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> buckets, y <span style="color:#f92672">=</span> pct)) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">geom_col</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme_minimal</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">labs</span>(x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Bins&#34;</span>, 
       y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Default rate&#34;</span>, 
       title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Monotonic binning for number of inquiries in past 6 months&#34;</span>, 
       subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Monotonically increasing event rate&#34;</span>)
</code></pre></div><p><img src="chart2-1.png" alt=""></p>
<h2 id="creating-a-function">Creating a function</h2>
<p>Finally, we can encapsulate everything we have done so far inside a function for better usability.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">create_bins <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(var, outcome, max_depth <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, plot <span style="color:#f92672">=</span> T){
  
  <span style="color:#75715e"># Check if relationship is positive or negative </span>
  <span style="color:#75715e"># Using spearman since it measures strength of monotonic relationship </span>
  corr <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cor</span>(var, outcome, method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;spearman&#34;</span>)
  direction <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ifelse</span>(corr <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">-1</span>)
  
  <span style="color:#75715e"># Build XGB model </span>
  mdl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">xgboost</span>(
    verbose <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
    data <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.matrix</span>(var),
    label <span style="color:#f92672">=</span> outcome,
    nrounds <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,  
    params <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(objective <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;binary:logistic&#34;</span>, <span style="color:#75715e">## Binary outcome</span>
                  monotone_constraints <span style="color:#f92672">=</span> direction, 
                  max_depth <span style="color:#f92672">=</span> max_depth, 
                  eval_metric <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;auc&#34;</span>))
  
  <span style="color:#75715e"># Retrieve splits </span>
  splits <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">xgb.model.dt.tree</span>(model <span style="color:#f92672">=</span> mdl)
  cuts <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#f92672">-</span><span style="color:#66d9ef">Inf</span>, <span style="color:#a6e22e">sort</span>(splits<span style="color:#f92672">$</span>Split), <span style="color:#66d9ef">Inf</span>)
  binned <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cut</span>(var, 
                breaks <span style="color:#f92672">=</span> cuts, 
                include.lowest <span style="color:#f92672">=</span> T, 
                right <span style="color:#f92672">=</span> T, 
                ordered_result <span style="color:#f92672">=</span> T)
  
  <span style="color:#75715e"># Create an event rate plot</span>
  plt <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(outcome, binned) <span style="color:#f92672">%&gt;%</span> 
      <span style="color:#a6e22e">group_by</span>(binned) <span style="color:#f92672">%&gt;%</span>
      <span style="color:#a6e22e">summarise</span>(total <span style="color:#f92672">=</span> <span style="color:#a6e22e">n</span>(),
                events <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum</span>(outcome <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">%&gt;%</span>
      <span style="color:#a6e22e">mutate</span>(pct <span style="color:#f92672">=</span> events<span style="color:#f92672">/</span>total) <span style="color:#f92672">%&gt;%</span>
      <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> binned, y <span style="color:#f92672">=</span> pct)) <span style="color:#f92672">+</span> 
      <span style="color:#a6e22e">geom_col</span>() <span style="color:#f92672">+</span> 
      <span style="color:#a6e22e">theme_minimal</span>() <span style="color:#f92672">+</span> 
      <span style="color:#a6e22e">labs</span>(x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Bins&#34;</span>, 
           y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Event Rate&#34;</span>, 
           title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Monotonic binning output&#34;</span>)
    
  <span style="color:#a6e22e">if</span>(plot <span style="color:#f92672">==</span> T){
    <span style="color:#a6e22e">print</span>(plt)
  }
  
  <span style="color:#75715e"># List to be returned</span>
  lst <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">list</span>(
    var <span style="color:#f92672">=</span> var, 
    binned_var <span style="color:#f92672">=</span> binned, 
    cor <span style="color:#f92672">=</span> corr, 
    plot <span style="color:#f92672">=</span> plt
  )
  
  <span style="color:#a6e22e">return</span>(lst)
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Test function</span>
v1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">create_bins</span>(train<span style="color:#f92672">$</span>fico_range_high, train<span style="color:#f92672">$</span>bad_flag, max_depth <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, plot <span style="color:#f92672">=</span> F)
v2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">create_bins</span>(train<span style="color:#f92672">$</span>delinq_amnt, train<span style="color:#f92672">$</span>bad_flag, max_depth <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, plot <span style="color:#f92672">=</span> F)
v3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">create_bins</span>(train<span style="color:#f92672">$</span>int_rate, train<span style="color:#f92672">$</span>bad_flag, max_depth <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, plot <span style="color:#f92672">=</span> F)
v4 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">create_bins</span>(train<span style="color:#f92672">$</span>annual_inc, train<span style="color:#f92672">$</span>bad_flag, max_depth <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, plot <span style="color:#f92672">=</span> F)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">grid.arrange</span>(v1<span style="color:#f92672">$</span>plot <span style="color:#f92672">+</span> <span style="color:#a6e22e">labs</span>(subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Fico Range High&#34;</span>), 
             v2<span style="color:#f92672">$</span>plot <span style="color:#f92672">+</span> <span style="color:#a6e22e">labs</span>(subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Delinq Amount&#34;</span>), 
             v3<span style="color:#f92672">$</span>plot <span style="color:#f92672">+</span> <span style="color:#a6e22e">labs</span>(subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Interest Rate&#34;</span>), 
             v4<span style="color:#f92672">$</span>plot <span style="color:#f92672">+</span> <span style="color:#a6e22e">labs</span>(subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Annual Income&#34;</span>), 
             ncol <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
</code></pre></div><p><img src="chart3-1.png" alt=""></p>
<p>And that&rsquo;s it! We can use what we just built to discretise variables we need, perform <code>one-hot-encoding</code> or <code>WOE-transformations</code> and feed the appropriate model matrix to our choice of statistical routine.</p>
<h2 id="parting-notes">Parting notes</h2>
<p>Check out this package called <a href="https://github.com/statcompute/mob"><code>MonotonicOptimalBinning</code></a> by Wensui Liu which offers multiple binning strategies like isotonic binning, quantile binning and k-means binning.</p>
<p><em>Thoughts? Comments? Helpful? Not helpful? Like to see anything else added in here? Let me know!</em></p>

      </article>
      

      
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
  this.page.url = "https://rtichoke.netlify.app/post/monotonic_binning_using_xgboost/";
  this.page.identifier = "d5ce65d31496d17b297eed1b3fdc7cee";
  this.page.title = "Monotonic binning using XGBOOST";
};

(function() {
  window.setTimeout(function() {
    var d = document;
    var s = d.createElement('script');
    s.src = 'https://rtichoke.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    s.setAttribute("defer", "");
    d.body.appendChild(s);
  }, 2500);
})();
</script>

    </div>
  </div>
</div>

  </main>
  <footer class="footer">
  <div class="ax-l-i max-w-6xl">
    <nav class="flex items-center justify-center">
    </nav>
    <div class="footer-social flex items-center justify-center mt-4">
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Twitter" href="https://twitter.com/r0yr2"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11 0 0 1-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56 0 0 0-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57 0 0 0 2.914 5.452 6.48 6.48 0 0 1-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42 0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18 0 0 1-8.134 2.798c-.538 0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072 0 18.672-10 18.672-18.668 0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a>
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="GitHub" href="https://github.com/royr2"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.998 0C7.164 0 0 7.35 0 16.417 0 23.67 4.584 29.82 10.944 31.994c.8.15 1.092-.356 1.092-.79l-.022-2.792c-4.45.99-5.4-2.202-5.4-2.202-.726-1.896-1.776-2.4-1.776-2.4-1.454-1.018.108-.998.108-.998 1.606.117 2.45 1.693 2.45 1.693 1.428 2.507 3.746 1.784 4.658 1.363.144-1.06.558-1.784 1.016-2.195-3.552-.415-7.288-1.823-7.288-8.113 0-1.792.624-3.258 1.648-4.406-.166-.415-.714-2.085.156-4.344 0 0 1.344-.44 4.4 1.683 1.276-.364 2.644-.546 4.006-.552a14.98 14.98 0 0 1 4.006.554C23.062 6.37 24.404 6.8 24.404 6.8c.872 2.26.324 3.93.16 4.344 1.026 1.148 1.644 2.614 1.644 4.406 0 6.306-3.74 7.694-7.304 8.1.574.507 1.086 1.51 1.086 3.04l-.02 4.503c0 .44.288.95 1.1.788C27.42 29.817 32 23.667 32 16.417 32 7.35 24.836 0 15.998 0z"/></svg></a>
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="LinkedIn" href="https://www.linkedin.com/in/riddhimanr"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M29.692 0H2.308A2.31 2.31 0 0 0 0 2.308v27.384A2.31 2.31 0 0 0 2.308 32h27.384A2.31 2.31 0 0 0 32 29.692V2.308A2.31 2.31 0 0 0 29.692 0zM11.35 24.188H7.454V12.464h3.897v11.723zM9.402 10.863h-.025c-1.308 0-2.153-.9-2.153-2.025 0-1.15.872-2.026 2.205-2.026s2.153.875 2.18 2.026c0 1.125-.846 2.025-2.205 2.025zm16 13.324h-3.896v-6.272c0-1.576-.564-2.65-1.974-2.65-1.076 0-1.717.725-2 1.425-.103.25-.128.6-.128.95v6.547h-3.896V12.464h3.896v1.66c.518-.8 1.444-1.935 3.512-1.935 2.564 0 4.486 1.676 4.486 5.276v6.722z"/></svg></a>
    </div>

    <div class="footer-copyright text-sm text-center text-gray-400 mt-4">
      &#169; 2020-2021 R&#39;tichoke
    </div>
    <div class="text-sm sm:text-xs text-center text-gray-400 mt-2">
      Powered by <a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral">Axiom</a>
    </div>
  </div>
</footer>

<script src="/bundle.js?v=1632374292"></script>


</body>
</html>
