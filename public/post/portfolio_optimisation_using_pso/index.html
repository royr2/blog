<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name="hugo-theme" content="Axiom 0.8.0">



  <link rel="icon" type="image/png" sizes="32x32" href="/">
  <link rel="icon" type="image/x-icon" href="/">
  <link rel="apple-touch-icon" href="/">
  <link rel="canonical" href="https://rtichoke.netlify.app/post/portfolio_optimisation_using_pso/">
<link rel="preload" as="style" href="/bundle.css?v=1641649589" media="all">
<link rel="stylesheet" href="/bundle.css?v=1641649589" media="all">
<style>.cdata pre{background-color:#1f2937;color:#e5e7eb}.cdata :not(pre)>code{background-color:#f3f4f6;color:#7c3aed}.chroma .err{background-color:#991b1b;color:#fecaca}.chroma .hl{background-color:#374151}.chroma .ln{color:#9ca3af}.chroma .k,.chroma .kc,.chroma .kd,.chroma .kn,.chroma .kp,.chroma .kr{color:#60a5fa}.chroma .kt{color:#a78bfa}.chroma .na,.chroma .nb{color:#fbbf24}.chroma .nc{color:#f87171}.chroma .no{color:#34d399}.chroma .nd{color:#f87171}.chroma .ne{color:#f87171}.chroma .nf{color:#fbbf24}.chroma .nt{color:#f87171}.chroma .l{color:#a78bfa}.chroma .dl,.chroma .ld,.chroma .s,.chroma .s2,.chroma .sa,.chroma .sb,.chroma .sc,.chroma .sd{color:#34d399}.chroma .se{color:#9ca3af}.chroma .s1,.chroma .sh,.chroma .si,.chroma .sr,.chroma .ss,.chroma .sx{color:#34d399}.chroma .il,.chroma .m,.chroma .mb,.chroma .mf,.chroma .mh,.chroma .mi,.chroma .mo{color:#a78bfa}.chroma .o,.chroma .ow{color:#93c5fd}.chroma .c,.chroma .c1,.chroma .ch,.chroma .cm,.chroma .cp,.chroma .cpf,.chroma .cs,.chroma .p{color:#9ca3af}.chroma .ge{font-style:italic}.chroma .gs{font-weight:700}
</style>



<title>Find optimal portfolios using particle swarm optimisation in R : R&#39;tichoke</title>

<meta property="og:title" content="Find optimal portfolios using particle swarm optimisation in R">
<meta property="og:site_name" content="R&#39;tichoke">
<meta property="og:url" content="https://rtichoke.netlify.app/post/portfolio_optimisation_using_pso/">
<link rel="image_src" href="https://rtichoke.netlify.app/">
<meta property="og:image" content="https://rtichoke.netlify.app/">
<meta property="og:image:width" content="">
<meta property="og:image:height" content="">
<meta property="og:type" content="article">
<meta property="og:locale" content="en_us">
<meta property="og:description" content="How to perform portfolio optimisation using a particle swarm optimiser in R">
<meta name="description" content="How to perform portfolio optimisation using a particle swarm optimiser in R">
<meta property="og:updated_time" content="2021-11-05T00:00:00Z">
<meta property="fb:app_id" content="">
<meta name="author" content="Riddhiman">
<meta property="article:author" content="https://linkedin.com/in/riddhimanr">
<meta property="article:published_time" content="2021-11-05T00:00:00Z">
<meta property="article:modified_time" content="2021-11-05T00:00:00Z">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "Find optimal portfolios using particle swarm optimisation in R",
  "alternativeHeadline": "How to perform portfolio optimisation using a particle swarm optimiser in R",
  "url": "https://rtichoke.netlify.app/post/portfolio_optimisation_using_pso/",
  "image": "https://rtichoke.netlify.app/",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://rtichoke.netlify.app/post/portfolio_optimisation_using_pso/"
  },
  "description": "How to perform portfolio optimisation using a particle swarm optimiser in R",
  "author": {
    "@type": "Person",
    "name": "Riddhiman"
  },
  "publisher": {
    "@type": "Organization",
    "name": "R'tichoke",
    "logo": {
      "@type": "ImageObject",
      "url": "https://rtichoke.netlify.app/"
    }
  },
  "datePublished": "2021-11-05T00:00:00Z",
  "dateModified": "2021-11-05T00:00:00Z",
  "articleBody": "\u003cp\u003eIn the \u003ca href=\"/post/pso_optimisation\"\u003elast post\u003c/a\u003e we explored how to build a particle swarm optimiser from scratch. In this post, let\u0026rsquo;s explore how we can leverage such an optimiser to perform mean variance optimisation to find optimal portfolios that satisfy certain constraints.\u003c/p\u003e\n\u003cp\u003eAdditional information on mean variance optimisation and the CAPM model is available in this \u003ca href=\"http://www.columbia.edu/~mh2078/FoundationsFE/MeanVariance-CAPM.pdf\"\u003epaper\u003c/a\u003e.\u003c/p\u003e\n\u003ch2 id=\"libraries\"\u003eLibraries\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# install.packages(pacman)\u003c/span\u003e\npacman\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ep_load\u003c/span\u003e(pso, ggplot2, dplyr, quantmod, tidyr, plotly) \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"pre-requisites\"\u003ePre-requisites\u003c/h2\u003e\n\u003cp\u003eWe\u0026rsquo;ll need a few things before we can actually start running some optimisations:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eHistorical prices data\u003c/li\u003e\n\u003cli\u003eHistorical returns data\u003c/li\u003e\n\u003cli\u003eObjective functions and constraints\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch4 id=\"ticker-information\"\u003eTicker information\u003c/h4\u003e\n\u003cp\u003eSince I am based out of India, I\u0026rsquo;ll restrict myself to stocks that are part of the  \u003ca href=\"https://www1.nseindia.com/live_market/dynaContent/live_watch/equities_stock_watch.htm\"\u003eNIFTY50\u003c/a\u003e index. First we\u0026rsquo;ll need the tickers for each of the 50 stocks. The list is available as a csv file on the NSE website \u003ca href=\"https://www1.nseindia.com/products/content/equities/indices/nifty_50.htm\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Read csv file directly into R\u003c/span\u003e\nticker_list \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eread.csv\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;https://www1.nseindia.com/content/indices/ind_nifty50list.csv\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003eclass\u003c/span\u003e(ticker_list)\n\u003cspan style=\"color:#75715e\"\u003e## [1] \u0026#34;data.frame\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Check if data was red in correctly\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(ticker_list[,\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e], \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e##                                 Company.Name           Industry     Symbol\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 Adani Ports and Special Economic Zone Ltd.           SERVICES ADANIPORTS\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2                          Asian Paints Ltd.     CONSUMER GOODS ASIANPAINT\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3                             Axis Bank Ltd. FINANCIAL SERVICES   AXISBANK\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4                            Bajaj Auto Ltd.         AUTOMOBILE BAJAJ-AUTO\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5                         Bajaj Finance Ltd. FINANCIAL SERVICES BAJFINANCE\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"historical-prices\"\u003eHistorical prices\u003c/h4\u003e\n\u003cp\u003eNow that we have the right set of tickers, we need historical price data. The \u003ccode\u003equantmod\u003c/code\u003e package is perfect for something like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Note that for India, tickers need to be appended with \u0026#34;.NS\u0026#34;\u003c/span\u003e\ntickers \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epaste0\u003c/span\u003e(ticker_list\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eSymbol, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;.NS\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Pull data using quantmod::getSymbols\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Since getsymbols assigns data for each ticker to a \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# separate variable, we\u0026#39;ll use a loop to pull data for one\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# ticker at a time and append to a data.frame\u003c/span\u003e\nticker_df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e()\n\npb \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etxtProgressBar\u003c/span\u003e(min \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, max \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elength\u003c/span\u003e(tickers), style \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e)\n\n\u003cspan style=\"color:#a6e22e\"\u003efor\u003c/span\u003e(nms in tickers){\n  df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egetSymbols\u003c/span\u003e(Symbols \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e nms, verbose \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e F, src \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;yahoo\u0026#34;\u003c/span\u003e, auto.assign \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e F)\n  \n  \u003cspan style=\"color:#a6e22e\"\u003ecolnames\u003c/span\u003e(df) \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;open\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;high\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;low\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;close\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;volume\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;adjusted\u0026#34;\u003c/span\u003e)\n  df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e(df)\n  df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eticker \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e nms\n  df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003edate \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df)\n  ticker_df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbind\u003c/span\u003e(ticker_df, df)\n  \n  \u003cspan style=\"color:#a6e22e\"\u003esetTxtProgressBar\u003c/span\u003e(pb, \u003cspan style=\"color:#a6e22e\"\u003ewhich\u003c/span\u003e(tickers \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e nms))\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# We\u0026#39;ll need to do some data cleaning \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Using only closing prices\u003c/span\u003e\nprices_df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epivot_wider\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ticker_df, id_cols \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;date\u0026#34;\u003c/span\u003e, names_from \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ticker\u0026#34;\u003c/span\u003e, values_from \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;close\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# For simplicity, we\u0026#39;ll remove all NAs\u003c/span\u003e\nprices_df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ena.omit\u003c/span\u003e(prices_df)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Check date range for which data is available\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003erange\u003c/span\u003e(prices_df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003edate)\n\u003cspan style=\"color:#75715e\"\u003e## [1] \u0026#34;2017-11-17\u0026#34; \u0026#34;2021-10-29\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Check dimensions\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003edim\u003c/span\u003e(prices_df)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 973  51\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Chart to check if data has been downloaded correctly \u003c/span\u003e\nprices_df \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \n  \u003cspan style=\"color:#75715e\"\u003e# Convert to long form for easy plotting with ggplot\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egather\u003c/span\u003e(key \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ticker\u0026#34;\u003c/span\u003e, value \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;price\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003edate) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Attach industry\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eleft_join\u003c/span\u003e(ticker_list \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n              \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ticker \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epaste0\u003c/span\u003e(Symbol, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;.NS\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n              \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(ticker, industry \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Industry),\n            by \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ticker\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(date \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.Date\u003c/span\u003e(date)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \n  \u003cspan style=\"color:#75715e\"\u003e# Showing only metals\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(industry \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;METALS\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \n  \u003cspan style=\"color:#75715e\"\u003e# Plot with ggplot\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e date, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e price, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ticker)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egeom_line\u003c/span\u003e(size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_brewer\u003c/span\u003e(palette \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;RdBu\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Closing Prices\u0026#34;\u003c/span\u003e, \n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Nifty 50 metal stocks\u0026#34;\u003c/span\u003e,\n       x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Date\u0026#34;\u003c/span\u003e, \n       y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Closing Price\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;top\u0026#34;\u003c/span\u003e, \n        legend.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(colour \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;transparent\u0026#34;\u003c/span\u003e), \n        axis.title.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(face \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e), \n        axis.title.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(face \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"chart1-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch4 id=\"historical-returns\"\u003eHistorical returns\u003c/h4\u003e\n\u003cp\u003eFor the sake of simplicity we\u0026rsquo;ll calculate daily returns.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Calculate daily returns\u003c/span\u003e\nreturns_df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapply\u003c/span\u003e(prices_df[,\u003cspan style=\"color:#ae81ff\"\u003e-1\u003c/span\u003e], \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(vec){\n  ret \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e vec\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elag\u003c/span\u003e(vec) \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ereturn\u003c/span\u003e(ret)\n})\n\nreturns_df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.data.frame\u003c/span\u003e(returns_df)\nreturns_df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e returns_df[\u003cspan style=\"color:#ae81ff\"\u003e-1\u003c/span\u003e,]  \u003cspan style=\"color:#75715e\"\u003e## Remove first row since that\u0026#39;s NA\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"objective-function-and-constraints\"\u003eObjective function and constraints\u003c/h2\u003e\n\u003cp\u003eThe objective function depends on three things:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMean returns (Reward)\u003c/li\u003e\n\u003cli\u003ePortfolio variance (Risk)\u003c/li\u003e\n\u003cli\u003eRisk aversion parameter\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAdditionally, we\u0026rsquo;ll add a constraint to ensure \u003ccode\u003efull investment\u003c/code\u003e i.e. individual weights must add-up to one.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Pre computing average returns and the covariance matrix\u003c/span\u003e\nmean_returns \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esapply\u003c/span\u003e(returns_df, mean)\ncov_mat \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecov\u003c/span\u003e(returns_df)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eobj_func \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(wts, \n                     risk_av \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, \n                     lambda1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, \n                     lambda2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1e2\u003c/span\u003e, \n                     ret_vec, cov_mat){\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Some matrix multiplication  \u003c/span\u003e\n  port_returns \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e ret_vec \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e wts\n  port_risk \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(wts) \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e cov_mat \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e wts\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Objective function \u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Note that alpha is the risk aversion parameter\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Higher the value of alpha the more conservative the portfolio\u003c/span\u003e\n  obj \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e port_returns \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e risk_av \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e port_risk\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Full investment penalisation \u003c/span\u003e\n  obj \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e obj \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e lambda1 \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(wts) \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)^2\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Returning negative since the optimiser does minimisation by default \u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# We need maximisation\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ereturn\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eobj)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"optimiser-2-asset-example\"\u003eOptimiser (2 asset example)\u003c/h2\u003e\n\u003cp\u003eWe\u0026rsquo;ll start with a two asset example just so we can visualise how everything comes together.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Calculate average returns and covariance matrix for 2 assets\u003c/span\u003e\nmean_returns_small \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapply\u003c/span\u003e(returns_df[,\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e], \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, mean)\ncov_mat_small \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecov\u003c/span\u003e(returns_df[,\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e])\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe\u0026rsquo;ll use the optimiser that we built previously (with small modifications). See \u003ca href=\"/posts/pso_optisation\"\u003ehere\u003c/a\u003e for more details.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003epso_optim \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(obj_func,\n                      c1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.05\u003c/span\u003e,\n                      c2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.05\u003c/span\u003e,\n                      w \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e,\n                      init_fact \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e,\n                      n_particles \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e20\u003c/span\u003e,\n                      n_dim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n                      n_iter \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e50\u003c/span\u003e,\n                      upper \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,\n                      lower \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e,\n                      n_avg \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e,\n                      \u003cspan style=\"color:#66d9ef\"\u003e...\u003c/span\u003e){\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Initialise positions\u003c/span\u003e\n  X \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ematrix\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003erunif\u003c/span\u003e(n_particles \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e n_dim), nrow \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e n_particles)\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Ensure upper and lower bounds are respected\u003c/span\u003e\n  X \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e (upper \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e lower) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lower\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Initialise velocities\u003c/span\u003e\n  dX \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ematrix\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003erunif\u003c/span\u003e(n_particles \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e n_dim) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e init_fact, ncol \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e n_dim)\n  dX \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e dX \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e (upper \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e lower) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lower\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Get first personal and global bests\u003c/span\u003e\n  pbest \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e X\n  pbest_obj \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapply\u003c/span\u003e(X, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, obj_func, \u003cspan style=\"color:#66d9ef\"\u003e...\u003c/span\u003e)\n  \n  gbest \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e pbest\u003cspan style=\"color:#a6e22e\"\u003e[which.min\u003c/span\u003e(pbest_obj),]\n  gbest_obj \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emin\u003c/span\u003e(pbest_obj)\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Initialise an empty data frame to store results\u003c/span\u003e\n  loc_df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e(X, iter \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, obj \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e pbest_obj)\n  iter \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n  \n  \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e(iter \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e n_iter){\n    \n    \u003cspan style=\"color:#75715e\"\u003e# Find updated velocities \u003c/span\u003e\n    dX \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e w \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e dX \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c1\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003erunif\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e(pbest \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e X) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c2\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003erunif\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(gbest \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(X))\n    \n    \u003cspan style=\"color:#75715e\"\u003e# Update positions\u003c/span\u003e\n    X \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e dX\n    \n    \u003cspan style=\"color:#75715e\"\u003e# Calculate objective function\u003c/span\u003e\n    obj \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapply\u003c/span\u003e(X, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, obj_func, \u003cspan style=\"color:#66d9ef\"\u003e...\u003c/span\u003e)\n    \n    \u003cspan style=\"color:#75715e\"\u003e# Update local and global bests\u003c/span\u003e\n    idx \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ewhich\u003c/span\u003e(obj \u003cspan style=\"color:#f92672\"\u003e\u0026lt;=\u003c/span\u003e pbest_obj)\n    pbest[idx,] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e X[idx,]\n    pbest_obj[idx] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e obj[idx]\n    \n    idx \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ewhich.min\u003c/span\u003e(pbest_obj)\n    gbest \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e pbest[idx,]\n    gbest_obj \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emin\u003c/span\u003e(pbest_obj)\n    \n    \u003cspan style=\"color:#75715e\"\u003e# Update iteration and store locations\u003c/span\u003e\n    iter \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e iter \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n    loc_df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbind\u003c/span\u003e(loc_df, \u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e(X, iter \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e iter, obj \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e pbest_obj))\n  }\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Create list containing relevant items to be returned\u003c/span\u003e\n  lst \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e loc_df, obj \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e gbest_obj, obj_loc \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e gbest)\n  \u003cspan style=\"color:#a6e22e\"\u003ereturn\u003c/span\u003e(lst)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eout \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epso_optim\u003c/span\u003e(obj_func,\n                 ret_vec \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e mean_returns_small, \n                 cov_mat \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cov_mat_small,\n                 lambda1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, risk_av \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e,\n                 n_particles \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e,\n                 n_dim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n                 n_iter \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e200\u003c/span\u003e,\n                 upper \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, lower \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \n                 c1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.02\u003c/span\u003e, c2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.02\u003c/span\u003e, w \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.05\u003c/span\u003e, init_fact \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.01\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Check if weights add to one\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(out\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eobj_loc)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.9975584\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can now visualise the function we were trying to optimise as well as the path each particle took to get to the optimal result (its interactive so feel free to play around with the plot).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003egrid \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eexpand.grid\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, by \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.01\u003c/span\u003e), \n                    y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, by \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.01\u003c/span\u003e))\n\ngrid\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eobj \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapply\u003c/span\u003e(grid, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, obj_func, ret_vec \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e mean_returns_small, cov_mat \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cov_mat_small, \n                  lambda1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, risk_av \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Interactive 3D scatter plot with mesh\u003c/span\u003e\np \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eplot_ly\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eadd_mesh\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e grid, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ex, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ey, z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eobj, inherit \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e F, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;red\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eadd_markers\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e out\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eX, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eX1, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eX2, z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eobj, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e iter, inherit \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e F, \n              marker \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n  \nhtmlwidgets\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003esaveWidget\u003c/span\u003e(p, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;plotly.html\u0026#34;\u003c/span\u003e) \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Interactive 3D scatter plot\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eplot_ly\u003c/span\u003e(out\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eX, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eX1, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eX2, z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eobj) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eadd_markers\u003c/span\u003e(size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eadd_mesh\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e grid, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ex, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ey, z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eobj, inherit \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e F)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ciframe src = \"plotly.html\" width=\"800\" height=\"600\"\u003e\u003c/iframe\u003e\r\n\u003cp\u003eLooks a little odd but gets the point across (hopefully) 😅\u003c/p\u003e\n\u003ch2 id=\"optimiser-multi-asset-example\"\u003eOptimiser (multi asset example)\u003c/h2\u003e\n\u003cp\u003eWe can now look to solve the optimisation problem for multiple assets. We can use the \u003cstrong\u003e\u003ca href=\"https://cran.r-project.org/web/packages/pso/index.html\"\u003epso\u003c/a\u003e\u003c/strong\u003e package to do this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003en_stocks \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003encol\u003c/span\u003e(returns_df)\nopt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epsoptim\u003c/span\u003e(par \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, n_stocks),\n               fn \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e obj_func,\n               ret_vec \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e mean_returns, \n               cov_mat \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cov_mat,\n               lambda1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, risk_av \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1000\u003c/span\u003e,\n               lower \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, n_stocks),\n               upper \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, n_stocks),\n               control \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(maxit \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e200\u003c/span\u003e, s \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e, maxit.stagnate \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e))\n\n\u003cspan style=\"color:#a6e22e\"\u003epaste\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Portfolio returns:\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eround\u003c/span\u003e(opt\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epar \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e mean_returns, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e## [1] \u0026#34;Portfolio returns: 0.00067\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003epaste\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Portfolio Std dev:\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eround\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(opt\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epar \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e cov_mat \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e opt\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epar), \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e## [1] \u0026#34;Portfolio Std dev: 0.0099\u0026#34;\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Check if weights add up to one \u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(opt\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epar)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.9935782\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd that\u0026rsquo;s pretty much it. Additional constraints can be added very easily. Say for example we wanted to add \u003ccode\u003etracking error\u003c/code\u003e so as to penalise deviations from a benchmark portfolio.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Benchmark portfolio \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# For now let\u0026#39;s use an equally weighted portfolio  \u003c/span\u003e\nbench_wts \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003en_stocks, n_stocks)\nbench_returns \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.matrix\u003c/span\u003e(returns_df) \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(bench_wts))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Update the objective function \u003c/span\u003e\nobj_func_TE \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(wts,  \n                        risk_av \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, \n                        lambda1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e,  \n                        lambda2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e50\u003c/span\u003e, \n                        ret_vec, cov_mat){\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Some matrix multiplication  \u003c/span\u003e\n  port_returns \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e ret_vec \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e wts\n  port_risk \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(wts) \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e cov_mat \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e wts\n  port_returns_ts \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.matrix\u003c/span\u003e(returns_df) \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(wts))\n  \n  obj \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e port_returns \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e risk_av \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e port_risk\n  obj \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e obj \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e lambda1 \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(wts) \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)^2\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Tracking error \u003c/span\u003e\n  obj \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e obj \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e lambda2 \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(port_returns_ts \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e bench_returns)\n  \n  \u003cspan style=\"color:#a6e22e\"\u003ereturn\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eobj) \n}\n\nopt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epsoptim\u003c/span\u003e(par \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, n_stocks),\n               fn \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e obj_func_TE,\n               ret_vec \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e mean_returns, \n               cov_mat \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cov_mat,\n               lambda1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, risk_av \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1000\u003c/span\u003e,\n               lower \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, n_stocks),\n               upper \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, n_stocks),\n               control \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(maxit \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e200\u003c/span\u003e, s \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e, maxit.stagnate \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e))\n\n\u003cspan style=\"color:#a6e22e\"\u003epaste\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Portfolio returns:\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eround\u003c/span\u003e(opt\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epar \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e mean_returns, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e## [1] \u0026#34;Portfolio returns: 0.00074\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003epaste\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Portfolio Std dev:\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eround\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(opt\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epar \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e cov_mat \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e opt\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epar), \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e## [1] \u0026#34;Portfolio Std dev: 0.01231\u0026#34;\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Check if weights add up to one \u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(opt\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epar)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.9960087\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch1 id=\"parting-notes\"\u003eParting notes\u003c/h1\u003e\n\u003cp\u003eI like how simple yet effective PSO is. However, due to the nature of how it works, results, especially for arbitrarily complex functions can be a challenge to work with. One might need to run it multiple times and do some kind of averaging to reduce variability in outputs.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eThoughts? Comments? Helpful? Not helpful? Like to see anything else added in here? Let me know!\u003c/em\u003e\u003c/p\u003e"
}
</script>

<link rel="preload" as="script" href="/bundle.js?v=1641649589">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://stats.g.doubleclick.net">
<link rel="preconnect" href="https://www.googleadservices.com">
<link rel="preload" as="script" href="https://www.googletagmanager.com/gtag/js?id=UA-57026003-1">
<script src="https://www.googletagmanager.com/gtag/js?id=UA-57026003-1"></script>
<script>
  window.dataLayer=window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js',new Date());
  gtag('config','UA-57026003-1');
</script>

</head>
<body>

  <header id="nav" class="header">
  <div class="ax-l-i max-w-6xl">
    <div class="ax-logo">
      <a class="block" href="/" title="R&#39;tichoke"><span class="font-semibold text-raven-900">R'tichoke</span></a>
    </div>
    <div class="ax-user">
      <a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target="_blank" rel="noopener nofollow" href="https://www.google.com/search?q=site:https://rtichoke.netlify.app/" title="Search">
        <svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923l-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33 0 0 0 2.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg>

      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="/post/">
        Posts
      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="/about/">
        About
      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="/rbloggers/">
        R-Bloggers
      </a>
    </div>
  </div>

  
  
</header>


  <main>
<div class="default-single">
  <div class="ax-title ax-l-o">
    <div class="ax-l-i max-w-4xl">
      <h1 class="post-title font-content-title font-normal leading-tight tracking-default text-40">Find optimal portfolios using particle swarm optimisation in R</h1>

      <div class="ax-meta flex items-center mt-5">
        <div class="flex-grow min-w-0">
          <div class="flex items-center">
  
  <div class="flex-shrink-0">
    <img
    class="w-12 h-12 sm:w-14 sm:h-14 object-cover p-3px rounded-full border border-blue-300"
    src="data:image/svg&#43;xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMzIgMzIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI&#43;PHBhdGggZmlsbD0iI2VjZWZmMSIgZD0iTTAgMGgzMnYzMkgweiIvPjxwYXRoIGZpbGw9IiM0NTVhNjQiIGQ9Ik0yOS4zMDUgMjQuNDA3Yy0uNzk1LS42My0xLjc2NS0xLjA4LTIuODE2LTEuM0wyMS40NzYgMjIuMWExLjEzIDEuMTMgMCAwIDEtLjkwNS0xLjEydi0xLjE1Yy4zMjItLjQ1My42MjYtMS4wNTQuOTQ0LTEuNjgyLjI0Ny0uNDg3LjYyLTEuMjIuODA1LTEuNCAxLjAxNS0xLjAyIDEuOTk1LTIuMTY1IDIuMy0zLjY0LjI4My0xLjM4NS4wMDUtMi4xMTItLjMyMi0yLjY5NyAwLTEuNDYtLjA0Ni0zLjI5LS4zOS00LjYyLS4wNC0xLjgtLjM2OC0yLjgxNC0xLjE5LTMuNy0uNTgtLjYzLTEuNDM1LS43NzUtMi4xMjMtLjg5LS4yNy0uMDQ2LS42NDItLjEtLjc4LS4xODNDMTguNTk0LjM0NyAxNy40LjAyNSAxNS45NTIgMGMtMyAuMTIzLTYuNzEgMi4wNC03Ljk1IDUuNDU0LS4zODQgMS4wNC0uMzQ1IDIuNzQ3LS4zMTMgNC4xMmwtLjAzLjgyNWMtLjI5NS41NzYtLjU4NSAxLjMwNy0uMyAyLjY5Ny4zMDIgMS40OCAxLjI4MiAyLjYyNiAyLjMxNSAzLjY2LjE3LjE3NC41NS45MTQuODAyIDEuNDAzbC45NSAxLjY3NXYxLjE1YzAgLjU0Ni0uMzgyIDEuMDE3LS45IDEuMTJMNS41IDIzLjExYy0xLjA0NS4yMjItMi4wMTQuNjctMi44MDcgMS4yOThhMS4xNSAxLjE1IDAgMCAwLS40MjcuODA1IDEuMTQgMS4xNCAwIDAgMCAuMjkzLjg1OUM1Ljk3NSAyOS44MzggMTAuODczIDMyIDE2IDMyczEwLjAyNy0yLjE2IDEzLjQ0LTUuOTNhMS4xNCAxLjE0IDAgMCAwLS4xMzUtMS42NjR6Ii8&#43;PC9zdmc&#43;Cg=="
    alt="">
	</div>
    
  <div class="flex-shrink-0 ml-2 leading-tight font-content-sans">
    <a class="block text-sm text-raven-800 hover:text-raven-900 hover:underline focus:underline" target="_blank" rel="noopener nofollow" title="Riddhiman" href="https://linkedin.com/in/riddhimanr">Riddhiman</a>
    <time class="text-sm text-raven-500" datetime="2021-11-05T00:00:00Z">Nov 5, 2021</time>
  </div>
</div>

        </div>
        <div>
          

<div class="flex items-center">
    <a class="flex-shrink-0 block text-raven-800 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Share on Twitter" href="https://twitter.com/intent/tweet?text=Find%20optimal%20portfolios%20using%20particle%20swarm%20optimisation%20in%20R%20by%20%40%25%21s%28%3cnil%3e%29%20https%3a%2f%2frtichoke.netlify.app%2fpost%2fportfolio_optimisation_using_pso%2f"><svg class="w-6 h-6 fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11 0 0 1-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56 0 0 0-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57 0 0 0 2.914 5.452 6.48 6.48 0 0 1-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42 0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18 0 0 1-8.134 2.798c-.538 0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072 0 18.672-10 18.672-18.668 0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg>
</a>
    <a class="ml-3 flex-shrink-0 block text-raven-800 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Share on Facebook" href="https://www.facebook.com/dialog/share?app_id=&display=page&href=https%3a%2f%2frtichoke.netlify.app%2fpost%2fportfolio_optimisation_using_pso%2f"><svg class="w-6 h-6 fill-current" viewBox="-7 -3.5 39 39" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.234 0H1.765C.8.001 0 .79 0 1.766v28.47C.001 31.2.79 32 1.766 32h15.328V19.625h-4.156V14.78h4.156v-3.564c0-4.134 2.523-6.384 6.21-6.384 1.766 0 3.284.13 3.726.2v4.32h-2.543c-2.006 0-2.394.953-2.394 2.352v3.085h4.797l-.625 4.844h-4.172V32h8.14C31.21 32 32 31.2 32 30.234V1.765C32 .8 31.21 0 30.234 0z"/></svg>
</a>
  
</div>
        </div>
      </div>
    </div>
  </div><div class="ax-content ax-l-o">
    <div class="ax-l-i max-w-4xl">
      <article class="cdata">
<p>In the <a href="/post/pso_optimisation">last post</a> we explored how to build a particle swarm optimiser from scratch. In this post, let&rsquo;s explore how we can leverage such an optimiser to perform mean variance optimisation to find optimal portfolios that satisfy certain constraints.</p>
<p>Additional information on mean variance optimisation and the CAPM model is available in this <a href="http://www.columbia.edu/~mh2078/FoundationsFE/MeanVariance-CAPM.pdf">paper</a>.</p>
<h2 id="libraries">Libraries</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># install.packages(pacman)</span>
pacman<span style="color:#f92672">::</span><span style="color:#a6e22e">p_load</span>(pso, ggplot2, dplyr, quantmod, tidyr, plotly) 
</code></pre></div><h2 id="pre-requisites">Pre-requisites</h2>
<p>We&rsquo;ll need a few things before we can actually start running some optimisations:</p>
<ol>
<li>Historical prices data</li>
<li>Historical returns data</li>
<li>Objective functions and constraints</li>
</ol>
<h4 id="ticker-information">Ticker information</h4>
<p>Since I am based out of India, I&rsquo;ll restrict myself to stocks that are part of the  <a href="https://www1.nseindia.com/live_market/dynaContent/live_watch/equities_stock_watch.htm">NIFTY50</a> index. First we&rsquo;ll need the tickers for each of the 50 stocks. The list is available as a csv file on the NSE website <a href="https://www1.nseindia.com/products/content/equities/indices/nifty_50.htm">here</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Read csv file directly into R</span>
ticker_list <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read.csv</span>(<span style="color:#e6db74">&#34;https://www1.nseindia.com/content/indices/ind_nifty50list.csv&#34;</span>)
<span style="color:#a6e22e">class</span>(ticker_list)
<span style="color:#75715e">## [1] &#34;data.frame&#34;</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Check if data was red in correctly</span>
<span style="color:#a6e22e">head</span>(ticker_list[,<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">3</span>], <span style="color:#ae81ff">5</span>)
<span style="color:#75715e">##                                 Company.Name           Industry     Symbol</span>
<span style="color:#75715e">## 1 Adani Ports and Special Economic Zone Ltd.           SERVICES ADANIPORTS</span>
<span style="color:#75715e">## 2                          Asian Paints Ltd.     CONSUMER GOODS ASIANPAINT</span>
<span style="color:#75715e">## 3                             Axis Bank Ltd. FINANCIAL SERVICES   AXISBANK</span>
<span style="color:#75715e">## 4                            Bajaj Auto Ltd.         AUTOMOBILE BAJAJ-AUTO</span>
<span style="color:#75715e">## 5                         Bajaj Finance Ltd. FINANCIAL SERVICES BAJFINANCE</span>
</code></pre></div><h4 id="historical-prices">Historical prices</h4>
<p>Now that we have the right set of tickers, we need historical price data. The <code>quantmod</code> package is perfect for something like this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Note that for India, tickers need to be appended with &#34;.NS&#34;</span>
tickers <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">paste0</span>(ticker_list<span style="color:#f92672">$</span>Symbol, <span style="color:#e6db74">&#34;.NS&#34;</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Pull data using quantmod::getSymbols</span>
<span style="color:#75715e"># Since getsymbols assigns data for each ticker to a </span>
<span style="color:#75715e"># separate variable, we&#39;ll use a loop to pull data for one</span>
<span style="color:#75715e"># ticker at a time and append to a data.frame</span>
ticker_df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>()

pb <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">txtProgressBar</span>(min <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, max <span style="color:#f92672">=</span> <span style="color:#a6e22e">length</span>(tickers), style <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>)

<span style="color:#a6e22e">for</span>(nms in tickers){
  df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">getSymbols</span>(Symbols <span style="color:#f92672">=</span> nms, verbose <span style="color:#f92672">=</span> F, src <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;yahoo&#34;</span>, auto.assign <span style="color:#f92672">=</span> F)
  
  <span style="color:#a6e22e">colnames</span>(df) <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;open&#34;</span>, <span style="color:#e6db74">&#34;high&#34;</span>, <span style="color:#e6db74">&#34;low&#34;</span>, <span style="color:#e6db74">&#34;close&#34;</span>, <span style="color:#e6db74">&#34;volume&#34;</span>, <span style="color:#e6db74">&#34;adjusted&#34;</span>)
  df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(df)
  df<span style="color:#f92672">$</span>ticker <span style="color:#f92672">&lt;-</span> nms
  df<span style="color:#f92672">$</span>date <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rownames</span>(df)
  ticker_df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbind</span>(ticker_df, df)
  
  <span style="color:#a6e22e">setTxtProgressBar</span>(pb, <span style="color:#a6e22e">which</span>(tickers <span style="color:#f92672">==</span> nms))
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># We&#39;ll need to do some data cleaning </span>
<span style="color:#75715e"># Using only closing prices</span>
prices_df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">pivot_wider</span>(data <span style="color:#f92672">=</span> ticker_df, id_cols <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;date&#34;</span>, names_from <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ticker&#34;</span>, values_from <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;close&#34;</span>)

<span style="color:#75715e"># For simplicity, we&#39;ll remove all NAs</span>
prices_df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">na.omit</span>(prices_df)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Check date range for which data is available</span>
<span style="color:#a6e22e">range</span>(prices_df<span style="color:#f92672">$</span>date)
<span style="color:#75715e">## [1] &#34;2017-11-17&#34; &#34;2021-10-29&#34;</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Check dimensions</span>
<span style="color:#a6e22e">dim</span>(prices_df)
<span style="color:#75715e">## [1] 973  51</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Chart to check if data has been downloaded correctly </span>
prices_df <span style="color:#f92672">%&gt;%</span> 
  
  <span style="color:#75715e"># Convert to long form for easy plotting with ggplot</span>
  <span style="color:#a6e22e">gather</span>(key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ticker&#34;</span>, value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;price&#34;</span>, <span style="color:#f92672">-</span>date) <span style="color:#f92672">%&gt;%</span>
  
  <span style="color:#75715e"># Attach industry</span>
  <span style="color:#a6e22e">left_join</span>(ticker_list <span style="color:#f92672">%&gt;%</span> 
              <span style="color:#a6e22e">mutate</span>(ticker <span style="color:#f92672">=</span> <span style="color:#a6e22e">paste0</span>(Symbol, <span style="color:#e6db74">&#34;.NS&#34;</span>)) <span style="color:#f92672">%&gt;%</span> 
              <span style="color:#a6e22e">select</span>(ticker, industry <span style="color:#f92672">=</span> Industry),
            by <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ticker&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(date <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.Date</span>(date)) <span style="color:#f92672">%&gt;%</span> 
  
  <span style="color:#75715e"># Showing only metals</span>
  <span style="color:#a6e22e">filter</span>(industry <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;METALS&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  
  <span style="color:#75715e"># Plot with ggplot</span>
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> date, y <span style="color:#f92672">=</span> price, color <span style="color:#f92672">=</span> ticker)) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">geom_line</span>(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.8</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme_minimal</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">scale_color_brewer</span>(palette <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;RdBu&#34;</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">labs</span>(title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Closing Prices&#34;</span>, 
       subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Nifty 50 metal stocks&#34;</span>,
       x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Date&#34;</span>, 
       y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Closing Price&#34;</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;top&#34;</span>, 
        legend.title <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_text</span>(colour <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;transparent&#34;</span>), 
        axis.title.x <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_text</span>(face <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bold&#34;</span>), 
        axis.title.y <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_text</span>(face <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bold&#34;</span>))
</code></pre></div><p><img src="chart1-1.png" alt=""></p>
<h4 id="historical-returns">Historical returns</h4>
<p>For the sake of simplicity we&rsquo;ll calculate daily returns.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Calculate daily returns</span>
returns_df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">apply</span>(prices_df[,<span style="color:#ae81ff">-1</span>], <span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">function</span>(vec){
  ret <span style="color:#f92672">&lt;-</span> vec<span style="color:#f92672">/</span><span style="color:#a6e22e">lag</span>(vec) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
  <span style="color:#a6e22e">return</span>(ret)
})

returns_df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">as.data.frame</span>(returns_df)
returns_df <span style="color:#f92672">&lt;-</span> returns_df[<span style="color:#ae81ff">-1</span>,]  <span style="color:#75715e">## Remove first row since that&#39;s NA</span>
</code></pre></div><h2 id="objective-function-and-constraints">Objective function and constraints</h2>
<p>The objective function depends on three things:</p>
<ul>
<li>Mean returns (Reward)</li>
<li>Portfolio variance (Risk)</li>
<li>Risk aversion parameter</li>
</ul>
<p>Additionally, we&rsquo;ll add a constraint to ensure <code>full investment</code> i.e. individual weights must add-up to one.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Pre computing average returns and the covariance matrix</span>
mean_returns <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sapply</span>(returns_df, mean)
cov_mat <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cov</span>(returns_df)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">obj_func <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(wts, 
                     risk_av <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, 
                     lambda1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, 
                     lambda2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e2</span>, 
                     ret_vec, cov_mat){
  
  <span style="color:#75715e"># Some matrix multiplication  </span>
  port_returns <span style="color:#f92672">&lt;-</span> ret_vec <span style="color:#f92672">%*%</span> wts
  port_risk <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">t</span>(wts) <span style="color:#f92672">%*%</span> cov_mat <span style="color:#f92672">%*%</span> wts
  
  <span style="color:#75715e"># Objective function </span>
  <span style="color:#75715e"># Note that alpha is the risk aversion parameter</span>
  <span style="color:#75715e"># Higher the value of alpha the more conservative the portfolio</span>
  obj <span style="color:#f92672">&lt;-</span> port_returns <span style="color:#f92672">-</span> risk_av <span style="color:#f92672">*</span> port_risk
  
  <span style="color:#75715e"># Full investment penalisation </span>
  obj <span style="color:#f92672">&lt;-</span> obj <span style="color:#f92672">-</span> lambda1 <span style="color:#f92672">*</span> (<span style="color:#a6e22e">sum</span>(wts) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)^2
  
  <span style="color:#75715e"># Returning negative since the optimiser does minimisation by default </span>
  <span style="color:#75715e"># We need maximisation</span>
  <span style="color:#a6e22e">return</span>(<span style="color:#f92672">-</span>obj)
}
</code></pre></div><h2 id="optimiser-2-asset-example">Optimiser (2 asset example)</h2>
<p>We&rsquo;ll start with a two asset example just so we can visualise how everything comes together.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Calculate average returns and covariance matrix for 2 assets</span>
mean_returns_small <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">apply</span>(returns_df[,<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">2</span>, mean)
cov_mat_small <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cov</span>(returns_df[,<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>])
</code></pre></div><p>We&rsquo;ll use the optimiser that we built previously (with small modifications). See <a href="/posts/pso_optisation">here</a> for more details.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">pso_optim <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(obj_func,
                      c1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.05</span>,
                      c2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.05</span>,
                      w <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.8</span>,
                      init_fact <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>,
                      n_particles <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>,
                      n_dim <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,
                      n_iter <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>,
                      upper <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
                      lower <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
                      n_avg <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>,
                      <span style="color:#66d9ef">...</span>){
  
  <span style="color:#75715e"># Initialise positions</span>
  X <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">matrix</span>(<span style="color:#a6e22e">runif</span>(n_particles <span style="color:#f92672">*</span> n_dim), nrow <span style="color:#f92672">=</span> n_particles)
  
  <span style="color:#75715e"># Ensure upper and lower bounds are respected</span>
  X <span style="color:#f92672">&lt;-</span> X <span style="color:#f92672">*</span> (upper <span style="color:#f92672">-</span> lower) <span style="color:#f92672">+</span> lower
  
  <span style="color:#75715e"># Initialise velocities</span>
  dX <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">matrix</span>(<span style="color:#a6e22e">runif</span>(n_particles <span style="color:#f92672">*</span> n_dim) <span style="color:#f92672">*</span> init_fact, ncol <span style="color:#f92672">=</span> n_dim)
  dX <span style="color:#f92672">&lt;-</span> dX <span style="color:#f92672">*</span> (upper <span style="color:#f92672">-</span> lower) <span style="color:#f92672">+</span> lower
  
  <span style="color:#75715e"># Get first personal and global bests</span>
  pbest <span style="color:#f92672">&lt;-</span> X
  pbest_obj <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">apply</span>(X, <span style="color:#ae81ff">1</span>, obj_func, <span style="color:#66d9ef">...</span>)
  
  gbest <span style="color:#f92672">&lt;-</span> pbest<span style="color:#a6e22e">[which.min</span>(pbest_obj),]
  gbest_obj <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">min</span>(pbest_obj)
  
  <span style="color:#75715e"># Initialise an empty data frame to store results</span>
  loc_df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(X, iter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, obj <span style="color:#f92672">=</span> pbest_obj)
  iter <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
  
  <span style="color:#a6e22e">while</span>(iter <span style="color:#f92672">&lt;</span> n_iter){
    
    <span style="color:#75715e"># Find updated velocities </span>
    dX <span style="color:#f92672">&lt;-</span> w <span style="color:#f92672">*</span> dX <span style="color:#f92672">+</span> c1<span style="color:#f92672">*</span><span style="color:#a6e22e">runif</span>(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span>(pbest <span style="color:#f92672">-</span> X) <span style="color:#f92672">+</span> c2<span style="color:#f92672">*</span><span style="color:#a6e22e">runif</span>(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">t</span>(gbest <span style="color:#f92672">-</span> <span style="color:#a6e22e">t</span>(X))
    
    <span style="color:#75715e"># Update positions</span>
    X <span style="color:#f92672">&lt;-</span> X <span style="color:#f92672">+</span> dX
    
    <span style="color:#75715e"># Calculate objective function</span>
    obj <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">apply</span>(X, <span style="color:#ae81ff">1</span>, obj_func, <span style="color:#66d9ef">...</span>)
    
    <span style="color:#75715e"># Update local and global bests</span>
    idx <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">which</span>(obj <span style="color:#f92672">&lt;=</span> pbest_obj)
    pbest[idx,] <span style="color:#f92672">&lt;-</span> X[idx,]
    pbest_obj[idx] <span style="color:#f92672">&lt;-</span> obj[idx]
    
    idx <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">which.min</span>(pbest_obj)
    gbest <span style="color:#f92672">&lt;-</span> pbest[idx,]
    gbest_obj <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">min</span>(pbest_obj)
    
    <span style="color:#75715e"># Update iteration and store locations</span>
    iter <span style="color:#f92672">&lt;-</span> iter <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
    loc_df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbind</span>(loc_df, <span style="color:#a6e22e">data.frame</span>(X, iter <span style="color:#f92672">=</span> iter, obj <span style="color:#f92672">=</span> pbest_obj))
  }
  
  <span style="color:#75715e"># Create list containing relevant items to be returned</span>
  lst <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">list</span>(X <span style="color:#f92672">=</span> loc_df, obj <span style="color:#f92672">=</span> gbest_obj, obj_loc <span style="color:#f92672">=</span> gbest)
  <span style="color:#a6e22e">return</span>(lst)
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">out <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">pso_optim</span>(obj_func,
                 ret_vec <span style="color:#f92672">=</span> mean_returns_small, 
                 cov_mat <span style="color:#f92672">=</span> cov_mat_small,
                 lambda1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, risk_av <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>,
                 n_particles <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>,
                 n_dim <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,
                 n_iter <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>,
                 upper <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, lower <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, 
                 c1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.02</span>, c2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.02</span>, w <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.05</span>, init_fact <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>)

<span style="color:#75715e"># Check if weights add to one</span>
<span style="color:#a6e22e">sum</span>(out<span style="color:#f92672">$</span>obj_loc)
<span style="color:#75715e">## [1] 0.9975584</span>
</code></pre></div><p>We can now visualise the function we were trying to optimise as well as the path each particle took to get to the optimal result (its interactive so feel free to play around with the plot).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">grid <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">expand.grid</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">seq</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, by <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>), 
                    y <span style="color:#f92672">=</span> <span style="color:#a6e22e">seq</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, by <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>))

grid<span style="color:#f92672">$</span>obj <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">apply</span>(grid, <span style="color:#ae81ff">1</span>, obj_func, ret_vec <span style="color:#f92672">=</span> mean_returns_small, cov_mat <span style="color:#f92672">=</span> cov_mat_small, 
                  lambda1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, risk_av <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Interactive 3D scatter plot with mesh</span>
p <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">plot_ly</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">add_mesh</span>(data <span style="color:#f92672">=</span> grid, x <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>x, y <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>y, z <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>obj, inherit <span style="color:#f92672">=</span> F, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">add_markers</span>(data <span style="color:#f92672">=</span> out<span style="color:#f92672">$</span>X, x <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>X1, y <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>X2, z <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>obj, color <span style="color:#f92672">=</span> <span style="color:#f92672">~</span> iter, inherit <span style="color:#f92672">=</span> F, 
              marker <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>))
  
htmlwidgets<span style="color:#f92672">::</span><span style="color:#a6e22e">saveWidget</span>(p, <span style="color:#e6db74">&#34;plotly.html&#34;</span>) 
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Interactive 3D scatter plot</span>
<span style="color:#a6e22e">plot_ly</span>(out<span style="color:#f92672">$</span>X, x <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>X1, y <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>X2, z <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>obj) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">add_markers</span>(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">add_mesh</span>(data <span style="color:#f92672">=</span> grid, x <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>x, y <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>y, z <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>obj, inherit <span style="color:#f92672">=</span> F)
</code></pre></div><iframe src = "plotly.html" width="800" height="600"></iframe>
<p>Looks a little odd but gets the point across (hopefully) 😅</p>
<h2 id="optimiser-multi-asset-example">Optimiser (multi asset example)</h2>
<p>We can now look to solve the optimisation problem for multiple assets. We can use the <strong><a href="https://cran.r-project.org/web/packages/pso/index.html">pso</a></strong> package to do this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">n_stocks <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ncol</span>(returns_df)
opt <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">psoptim</span>(par <span style="color:#f92672">=</span> <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">0</span>, n_stocks),
               fn <span style="color:#f92672">=</span> obj_func,
               ret_vec <span style="color:#f92672">=</span> mean_returns, 
               cov_mat <span style="color:#f92672">=</span> cov_mat,
               lambda1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, risk_av <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>,
               lower <span style="color:#f92672">=</span> <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">0</span>, n_stocks),
               upper <span style="color:#f92672">=</span> <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">1</span>, n_stocks),
               control <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(maxit <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>, s <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>, maxit.stagnate <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>))

<span style="color:#a6e22e">paste</span>(<span style="color:#e6db74">&#34;Portfolio returns:&#34;</span>, <span style="color:#a6e22e">round</span>(opt<span style="color:#f92672">$</span>par <span style="color:#f92672">%*%</span> mean_returns, <span style="color:#ae81ff">5</span>))
<span style="color:#75715e">## [1] &#34;Portfolio returns: 0.00067&#34;</span>
<span style="color:#a6e22e">paste</span>(<span style="color:#e6db74">&#34;Portfolio Std dev:&#34;</span>, <span style="color:#a6e22e">round</span>(<span style="color:#a6e22e">sqrt</span>(opt<span style="color:#f92672">$</span>par <span style="color:#f92672">%*%</span> cov_mat <span style="color:#f92672">%*%</span> opt<span style="color:#f92672">$</span>par), <span style="color:#ae81ff">5</span>))
<span style="color:#75715e">## [1] &#34;Portfolio Std dev: 0.0099&#34;</span>

<span style="color:#75715e"># Check if weights add up to one </span>
<span style="color:#a6e22e">sum</span>(opt<span style="color:#f92672">$</span>par)
<span style="color:#75715e">## [1] 0.9935782</span>
</code></pre></div><p>And that&rsquo;s pretty much it. Additional constraints can be added very easily. Say for example we wanted to add <code>tracking error</code> so as to penalise deviations from a benchmark portfolio.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Benchmark portfolio </span>
<span style="color:#75715e"># For now let&#39;s use an equally weighted portfolio  </span>
bench_wts <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>n_stocks, n_stocks)
bench_returns <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">as.matrix</span>(returns_df) <span style="color:#f92672">%*%</span> <span style="color:#a6e22e">t</span>(<span style="color:#a6e22e">t</span>(bench_wts))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Update the objective function </span>
obj_func_TE <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(wts,  
                        risk_av <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, 
                        lambda1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>,  
                        lambda2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>, 
                        ret_vec, cov_mat){
  
  <span style="color:#75715e"># Some matrix multiplication  </span>
  port_returns <span style="color:#f92672">&lt;-</span> ret_vec <span style="color:#f92672">%*%</span> wts
  port_risk <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">t</span>(wts) <span style="color:#f92672">%*%</span> cov_mat <span style="color:#f92672">%*%</span> wts
  port_returns_ts <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">as.matrix</span>(returns_df) <span style="color:#f92672">%*%</span> <span style="color:#a6e22e">t</span>(<span style="color:#a6e22e">t</span>(wts))
  
  obj <span style="color:#f92672">&lt;-</span> port_returns <span style="color:#f92672">-</span> risk_av <span style="color:#f92672">*</span> port_risk
  obj <span style="color:#f92672">&lt;-</span> obj <span style="color:#f92672">-</span> lambda1 <span style="color:#f92672">*</span> (<span style="color:#a6e22e">sum</span>(wts) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)^2
  
  <span style="color:#75715e"># Tracking error </span>
  obj <span style="color:#f92672">&lt;-</span> obj <span style="color:#f92672">-</span> lambda2 <span style="color:#f92672">*</span> <span style="color:#a6e22e">sd</span>(port_returns_ts <span style="color:#f92672">-</span> bench_returns)
  
  <span style="color:#a6e22e">return</span>(<span style="color:#f92672">-</span>obj) 
}

opt <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">psoptim</span>(par <span style="color:#f92672">=</span> <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">0</span>, n_stocks),
               fn <span style="color:#f92672">=</span> obj_func_TE,
               ret_vec <span style="color:#f92672">=</span> mean_returns, 
               cov_mat <span style="color:#f92672">=</span> cov_mat,
               lambda1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, risk_av <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>,
               lower <span style="color:#f92672">=</span> <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">0</span>, n_stocks),
               upper <span style="color:#f92672">=</span> <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">1</span>, n_stocks),
               control <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(maxit <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>, s <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>, maxit.stagnate <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>))

<span style="color:#a6e22e">paste</span>(<span style="color:#e6db74">&#34;Portfolio returns:&#34;</span>, <span style="color:#a6e22e">round</span>(opt<span style="color:#f92672">$</span>par <span style="color:#f92672">%*%</span> mean_returns, <span style="color:#ae81ff">5</span>))
<span style="color:#75715e">## [1] &#34;Portfolio returns: 0.00074&#34;</span>
<span style="color:#a6e22e">paste</span>(<span style="color:#e6db74">&#34;Portfolio Std dev:&#34;</span>, <span style="color:#a6e22e">round</span>(<span style="color:#a6e22e">sqrt</span>(opt<span style="color:#f92672">$</span>par <span style="color:#f92672">%*%</span> cov_mat <span style="color:#f92672">%*%</span> opt<span style="color:#f92672">$</span>par), <span style="color:#ae81ff">5</span>))
<span style="color:#75715e">## [1] &#34;Portfolio Std dev: 0.01231&#34;</span>

<span style="color:#75715e"># Check if weights add up to one </span>
<span style="color:#a6e22e">sum</span>(opt<span style="color:#f92672">$</span>par)
<span style="color:#75715e">## [1] 0.9960087</span>
</code></pre></div><h1 id="parting-notes">Parting notes</h1>
<p>I like how simple yet effective PSO is. However, due to the nature of how it works, results, especially for arbitrarily complex functions can be a challenge to work with. One might need to run it multiple times and do some kind of averaging to reduce variability in outputs.</p>
<p><em>Thoughts? Comments? Helpful? Not helpful? Like to see anything else added in here? Let me know!</em></p>

      </article>
      

      
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
  this.page.url = "https://rtichoke.netlify.app/post/portfolio_optimisation_using_pso/";
  this.page.identifier = "587c4107379db713ec2b6f6dd8fe89d6";
  this.page.title = "Find optimal portfolios using particle swarm optimisation in R";
};

(function() {
  window.setTimeout(function() {
    var d = document;
    var s = d.createElement('script');
    s.src = 'https://rtichoke.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    s.setAttribute("defer", "");
    d.body.appendChild(s);
  }, 2500);
})();
</script>

    </div>
  </div>
</div>

  </main>
  <footer class="footer">
  <div class="ax-l-i max-w-6xl">
    <nav class="flex items-center justify-center">
    </nav>
    <div class="footer-social flex items-center justify-center mt-4">
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Twitter" href="https://twitter.com/r0yr2"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11 0 0 1-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56 0 0 0-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57 0 0 0 2.914 5.452 6.48 6.48 0 0 1-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42 0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18 0 0 1-8.134 2.798c-.538 0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072 0 18.672-10 18.672-18.668 0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a>
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="GitHub" href="https://github.com/royr2"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.998 0C7.164 0 0 7.35 0 16.417 0 23.67 4.584 29.82 10.944 31.994c.8.15 1.092-.356 1.092-.79l-.022-2.792c-4.45.99-5.4-2.202-5.4-2.202-.726-1.896-1.776-2.4-1.776-2.4-1.454-1.018.108-.998.108-.998 1.606.117 2.45 1.693 2.45 1.693 1.428 2.507 3.746 1.784 4.658 1.363.144-1.06.558-1.784 1.016-2.195-3.552-.415-7.288-1.823-7.288-8.113 0-1.792.624-3.258 1.648-4.406-.166-.415-.714-2.085.156-4.344 0 0 1.344-.44 4.4 1.683 1.276-.364 2.644-.546 4.006-.552a14.98 14.98 0 0 1 4.006.554C23.062 6.37 24.404 6.8 24.404 6.8c.872 2.26.324 3.93.16 4.344 1.026 1.148 1.644 2.614 1.644 4.406 0 6.306-3.74 7.694-7.304 8.1.574.507 1.086 1.51 1.086 3.04l-.02 4.503c0 .44.288.95 1.1.788C27.42 29.817 32 23.667 32 16.417 32 7.35 24.836 0 15.998 0z"/></svg></a>
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="LinkedIn" href="https://www.linkedin.com/in/riddhimanr"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M29.692 0H2.308A2.31 2.31 0 0 0 0 2.308v27.384A2.31 2.31 0 0 0 2.308 32h27.384A2.31 2.31 0 0 0 32 29.692V2.308A2.31 2.31 0 0 0 29.692 0zM11.35 24.188H7.454V12.464h3.897v11.723zM9.402 10.863h-.025c-1.308 0-2.153-.9-2.153-2.025 0-1.15.872-2.026 2.205-2.026s2.153.875 2.18 2.026c0 1.125-.846 2.025-2.205 2.025zm16 13.324h-3.896v-6.272c0-1.576-.564-2.65-1.974-2.65-1.076 0-1.717.725-2 1.425-.103.25-.128.6-.128.95v6.547h-3.896V12.464h3.896v1.66c.518-.8 1.444-1.935 3.512-1.935 2.564 0 4.486 1.676 4.486 5.276v6.722z"/></svg></a>
    </div>

    <div class="footer-copyright text-sm text-center text-gray-400 mt-4">
      &#169; 2021-2022 R&#39;tichoke
    </div>
    <div class="text-sm sm:text-xs text-center text-gray-400 mt-2">
      Powered by <a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral">Axiom</a>
    </div>
  </div>
</footer>

<script src="/bundle.js?v=1641649589"></script>


</body>
</html>
